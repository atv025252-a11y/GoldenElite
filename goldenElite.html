<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Elite | الإمبراطورية المطورة</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --light-gold: #f1d279;
            --neon: 0 0 30px rgba(212, 175, 55, 0.8);
            --bg: #050505;
        }

        body {
            background: var(--bg);
            color: white;
            font-family: 'Cairo', sans-serif;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% -20%, #1a1a1a 0%, #000 100%);
            background-attachment: fixed;
            background-size: cover;
            transition: background 0.5s ease;
        }

        .hidden { display: none !important; }

        /* الأنيميشن واللوجو */
        .main-logo-glow {
            font-size: 120px;
            color: var(--gold);
            text-shadow: var(--neon);
            margin-bottom: 20px;
            animation: pulse-glow 2s infinite alternate;
        }

        @keyframes pulse-glow {
            from { transform: scale(1); filter: drop-shadow(0 0 10px var(--gold)); }
            to { transform: scale(1.1); filter: drop-shadow(0 0 40px var(--light-gold)); }
        }

        .fa-coins {
            animation: coin-rotate 3s linear infinite;
            display: inline-block;
        }
        @keyframes coin-rotate {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        /* واجهة الدخول */
        #login-screen {
            height: 100vh; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
        }
        .login-box {
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(30px);
            padding: 40px 30px; border-radius: 40px; border: 1px solid rgba(212, 175, 55, 0.3);
            text-align: center; width: 100%; max-width: 400px; box-sizing: border-box;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5), var(--neon);
        }
        .input-group { width: 100%; margin-bottom: 20px; }
        .input-group input {
            width: 100%; background: rgba(0,0,0,0.6); border: 1px solid #333;
            padding: 15px; border-radius: 15px; color: white; text-align: center;
            font-size: 1rem; outline: none; box-sizing: border-box;
        }

        /* الكروت والشبكة */
        .item-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(212,175,55,0.2);
            padding: 20px; border-radius: 25px; text-align: center; transition: 0.3s;
            cursor: pointer; position: relative;
        }
        .item-card:hover { transform: translateY(-10px); box-shadow: var(--neon); border-color: var(--gold); }

        .subject-card {
            background: linear-gradient(145deg, rgba(20, 20, 20, 0.9), rgba(0, 0, 0, 1));
            border: 2px solid var(--gold); border-radius: 35px; padding: 30px;
            margin-bottom: 50px; position: relative; box-shadow: var(--neon);
        }

        .score-diamond {
            width: 55px; height: 55px; border: 2px solid var(--gold);
            background: rgba(212, 175, 55, 0.1); box-shadow: var(--neon);
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; transform: rotate(45deg);
        }
        .score-diamond span { transform: rotate(-45deg); }

        .admin-badge-new {
            display: inline-flex; align-items: center; gap: 10px;
            background: rgba(212, 175, 55, 0.1); border: 1px solid var(--gold);
            padding: 8px 20px; border-radius: 12px; color: var(--light-gold);
            margin-top: 10px; font-weight: bold;
        }

        .btn-gold {
            background: linear-gradient(to bottom, var(--light-gold), var(--gold));
            color: black; border: none; padding: 12px 25px; border-radius: 15px;
            font-weight: 900; cursor: pointer;
        }

        .admin-row {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
            background: rgba(0,0,0,0.4); padding: 15px; border-radius: 15px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }
        .admin-row input {
            background: #000; border: 1px solid #444; color: var(--light-gold);
            padding: 10px; border-radius: 10px; outline: none;
        }

        .back-home { position: fixed; bottom: 20px; left: 20px; width: 55px; height: 55px; background: #000; border: 2px solid var(--gold); border-radius: 50%; color: var(--gold); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; }
        
        .mini-avatar, .user-avatar-circle {
            border: 2px solid var(--gold); border-radius: 50%; 
            overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center;
        }

        .store-section {
            margin-bottom: 40px;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
            padding-top: 20px;
        }
        .store-section h2 { color: var(--gold); margin-bottom: 20px; text-shadow: var(--neon); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div class="main-logo-glow"><i class="fa-solid fa-crown"></i></div>
            <h1 style="color:var(--gold); letter-spacing: 5px;">GOLDEN ELITE</h1>
            <div class="input-group"><input type="text" id="userInput" placeholder="اسم المستخدم"></div>
            <div class="input-group"><input type="password" id="passInput" placeholder="كلمة المرور"></div>
            <button class="btn-gold" style="width: 100%;" onclick="login()">دخول القمة</button>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        <div style="text-align:center; padding:30px;">
            <div style="display:flex; align-items:center; justify-content:center; gap:20px; margin-bottom:20px;">
                <div class="mini-avatar" id="dash-avatar" style="width:60px; height:60px;"><i class="fa-solid fa-user"></i></div>
                <div style="display:inline-flex; align-items:center; gap:15px; padding:15px 40px; border:2px solid var(--gold); border-radius:50px; background:black; box-shadow:var(--neon);">
                    <i class="fa-solid fa-coins" style="color:var(--gold); font-size:2rem;"></i>
                    <span id="user-balance" style="font-size:2rem; font-weight:900;">0</span>
                </div>
            </div>
            <h2 id="welcome-msg" style="color: var(--gold);"></h2>
        </div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:20px; padding:20px; max-width:1000px; margin:auto;">
            <div class="item-card" onclick="showView('app-screen')"><i class="fa-solid fa-chart-line" style="font-size:2rem; color:var(--gold);"></i><h3>تتبع النقط</h3></div>
            <div class="item-card" onclick="showView('store-screen')"><i class="fa-solid fa-shop" style="font-size:2rem; color:var(--gold);"></i><h3>المتجر</h3></div>
            <div class="item-card" onclick="showView('custom-screen')"><i class="fa-solid fa-palette" style="font-size:2rem; color:var(--gold);"></i><h3>التخصيصات</h3></div>
            <div class="item-card" onclick="showView('profile-screen')"><i class="fa-solid fa-user-gear" style="font-size:2rem; color:var(--gold);"></i><h3>البروفايل</h3></div>
        </div>
        <div class="back-home" onclick="logout()"><i class="fa-solid fa-power-off"></i></div>
    </div>

    <div id="app-screen" class="hidden" style="padding: 20px;">
        <h1 style="text-align:center; color:var(--gold);">سجل الأباطرة</h1>
        <div id="subjects-container" style="max-width: 1150px; margin: auto;"></div>
        <div class="back-home" onclick="showView('dashboard-screen')"><i class="fa-solid fa-house"></i></div>
    </div>

    <div id="store-screen" class="hidden" style="padding: 20px;">
        <h1 style="text-align:center; color:var(--gold);">المتجر الملكي</h1>
        <div id="store-content" style="max-width:1100px; margin:auto;"></div>
        <div class="back-home" onclick="showView('dashboard-screen')"><i class="fa-solid fa-house"></i></div>
    </div>

    <div id="custom-screen" class="hidden" style="padding:40px; text-align:center;">
        <h1 style="color:var(--gold);">تخصيص المظهر</h1>
        <button class="btn-gold" onclick="applyBG('original')">المظهر الأصلي</button>
        <div id="inventory-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:20px; margin-top:30px;"></div>
        <div class="back-home" onclick="showView('dashboard-screen')"><i class="fa-solid fa-house"></i></div>
    </div>

    <div id="profile-screen" class="hidden" style="padding:40px; text-align:center;">
        <div class="user-avatar-circle" id="profile-avatar" style="width:150px; height:150px; margin:auto;"><i class="fa-solid fa-user" style="font-size:80px;"></i></div>
        <h2 id="profile-name" style="color: var(--gold);"></h2>
        <div id="img-upload-section" class="hidden">
            <input type="file" id="p-img-input" style="display:none" onchange="processImage(this)">
            <button class="btn-gold" onclick="document.getElementById('p-img-input').click()">تغيير الصورة</button>
        </div>
        <div class="back-home" onclick="showView('dashboard-screen')"><i class="fa-solid fa-house"></i></div>
    </div>

    <div id="admin-panel" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:2000; overflow-y:auto; padding:20px;">
        <div style="max-width:700px; margin:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--gold); padding-bottom:15px; margin-bottom:20px;">
                <h2 style="color:var(--gold);">لوحة التحكم</h2>
                <button class="btn-gold" onclick="closeAdmin()">حفظ سحابي</button>
            </div>
            <div id="students-edit-list"></div>
        </div>
    </div>

    <script>
        // --- إعدادات Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJFJZAyp7JNqosWxK6MVgvAh497Zz2i-g",
            authDomain: "golden-elite-1adc2.firebaseapp.com",
            databaseURL: "https://golden-elite-1adc2-default-rtdb.firebaseio.com",
            projectId: "golden-elite-1adc2",
            storageBucket: "golden-elite-1adc2.firebasestorage.app",
            messagingSenderId: "623365437454",
            appId: "1:623365437454:web:8677f0f5aeaa709892e45f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- البيانات المحلية (تم إضافة ريان عدولي) ---
        const users = [
            { id: "Aynaoubro", pass: "Elite#AY11", name: "محمد عبد الله أيناو", role: "admin", subject: "اللغة الفرنسية" },
            { id: "Allaapasha", pass: "Elite#AL22", name: "علاء فليو", role: "admin", subject: "اللغة العربية" },
            { id: "Aymirox", pass: "Elite#AY77", name: "أيمن مير", role: "admin", subject: "التربية الإسلامية" },
            { id: "CHAHIDOX", pass: "Elite#CH99", name: "محمد أمين شهيد", role: "admin", subject: "التاريخ والجغرافيا" },
            { id: "Zakaria 1bacsm", pass: "Zak@2026", name: "زكرياء ٱيت سعيد", role: "student" },
            { id: "Ayoubinho", pass: "Ayo@2026", name: "أيوب عسي", role: "student" },
            { id: "karounmax", pass: "Kar@2026", name: "عبد الإله قارون", role: "student" },
            { id: "ANASINHO", pass: "Ana@2026", name: "أنس غندور", role: "student" },
            { id: "Imrane", pass: "Imr@2026", name: "عمران عدنان", role: "student" },
            { id: "Abderrahmane", pass: "Abd@2026", name: "عبد الرحمن مويلا", role: "student" },
            { id: "Ettarbi", pass: "Ett@2026", name: "محمد أمين إتربي", role: "student" },
            { id: "Mouaad", pass: "Mou@2026", name: "معاذ عينوس", role: "student" },
            { id: "Ryaninho", pass: "Rya@2026", name: "ريان عدولي", role: "student" }
        ];

        const subjects = [
            { name: "التاريخ والجغرافيا", icon: "fa-earth-africa", admin: "محمد أمين شهيد", adminIcon: "fa-crown" },
            { name: "اللغة العربية", icon: "fa-pen-nib", admin: "علاء فليو", adminIcon: "fa-shield-halved" },
            { name: "التربية الإسلامية", icon: "fa-mosque", admin: "أيمن مير", adminIcon: "fa-kaaba" },
            { name: "اللغة الفرنسية", icon: "fa-language", admin: "محمد عبد الله أيناو", adminIcon: "fa-star" }
        ];

        const shopItems = [
            {id:'club_madrid', name:'ريال مدريد', price:500, type:'clubs', img:'https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg', bg:'linear-gradient(to bottom, #fff, #d4af37)'},
            {id:'club_barca', name:'برشلونة', price:500, type:'clubs', img:'https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg', bg:'linear-gradient(to bottom, #a50044, #004d98)'},
            {id:'c_gold', name:'ذهبي ملكي', price:150, type:'color', bg:'linear-gradient(45deg, #d4af37, #000)'},
            {id:'c_blue', name:'أزرق ملكي', price:100, type:'color', bg:'linear-gradient(45deg, #002366, #000)'},
            {id:'c_red', name:'أحمر ملكي', price:100, type:'color', bg:'linear-gradient(45deg, #8b0000, #000)'},
            {id:'c_green', name:'أخضر ملكي', price:100, type:'color', bg:'linear-gradient(45deg, #006400, #000)'},
            {id:'feat_img', name:'فتح البروفايل', price:300, type:'feature'},
            {id:'effect_stars', name:'باك الشهب', price:450, type:'effect', bg:'radial-gradient(circle at center, #1a1a1a 0%, #000 100%), url("https://www.transparenttextures.com/patterns/stardust.png")'}
        ];

        let currentUser = null;
        let scoresData = {};
        let storeData = {};

        // --- المزامنة اللحظية ---
        db.ref('/').on('value', (snap) => {
            const val = snap.val() || {};
            scoresData = val.scores || {};
            storeData = val.store || {};
            if(currentUser) refreshUI();
        });

        function login() {
            const u = document.getElementById('userInput').value;
            const p = document.getElementById('passInput').value;
            currentUser = users.find(x => x.id === u && x.pass === p);
            if(currentUser) {
                showView('dashboard-screen');
                document.getElementById('welcome-msg').innerText = `أهلاً بك يا ${currentUser.name}`;
                document.getElementById('profile-name').innerText = currentUser.name;
            } else alert("بيانات خاطئة!");
        }

        function calculateCoins(sc) {
            if (sc >= 20) return 100;
            if (sc >= 19) return 85;
            if (sc >= 18) return 70;
            if (sc >= 17) return 65;
            if (sc >= 16) return 50;
            if (sc >= 15) return 35;
            if (sc >= 14) return 20;
            if (sc >= 13) return 15;
            if (sc >= 12) return 8;
            if (sc >= 11) return 5;
            return 0;
        }

        function refreshUI() {
            let total = 0;
            // احتساب الكوينز بناءً على القواعد الجديدة لكل النقاط المسجلة
            Object.keys(scoresData).forEach(key => {
                if (key.startsWith(currentUser.id)) {
                    let d = scoresData[key];
                    if (d && d.score !== '--') {
                        let sc = parseFloat(d.score);
                        total += calculateCoins(sc);
                    }
                }
            });

            let spent = storeData[currentUser.id]?.spent || 0;
            document.getElementById('user-balance').innerText = total - spent;

            const avatarData = storeData[currentUser.id]?.avatar;
            const avatarHtml = avatarData ? `<img src="${avatarData}" style="width:100%;height:100%;object-fit:cover;">` : `<i class="fa-solid fa-user"></i>`;
            document.getElementById('dash-avatar').innerHTML = avatarHtml;
            document.getElementById('profile-avatar').innerHTML = avatarHtml;

            if(storeData[currentUser.id]?.owned?.includes('feat_img')) document.getElementById('img-upload-section').classList.remove('hidden');
        }

        function renderApp() {
            const container = document.getElementById('subjects-container');
            container.innerHTML = subjects.map(s => {
                let exams = "";
                for(let i=1; i<=6; i++) {
                    const d = scoresData[`${currentUser.id}_${s.name}_${i}`] || {score:'--', comm:'لا ملاحظات'};
                    exams += `<div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border:1px solid rgba(212,175,55,0.2);">
                        <div><b style="color:var(--gold)">الفرض ${i}</b><br><small>${d.comm}</small></div>
                        <div class="score-diamond"><span>${d.score}</span></div>
                    </div>`;
                }
                return `<div class="subject-card">
                    <div style="display:flex; align-items:center; gap:20px;"><i class="fa-solid ${s.icon}" style="font-size:3rem; color:var(--gold);"></i><h2 style="color:var(--gold);">${s.name}</h2></div>
                    <div class="admin-badge-new"><i class="fa-solid ${s.adminIcon}"></i> المكلف: ${s.admin}</div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:15px; margin-top:20px;">${exams}</div>
                    ${(currentUser.role==='admin' && currentUser.subject===s.name) ? `<button class="btn-gold" style="width:100%; margin-top:20px" onclick="openAdmin('${s.name}')">تعديل النقط</button>` : ''}
                </div>`;
            }).join('');
        }

        function openAdmin(sName) {
            document.getElementById('admin-panel').classList.remove('hidden');
            document.getElementById('students-edit-list').innerHTML = users.map(u => {
                let rows = "";
                for(let i=1; i<=6; i++) {
                    let d = scoresData[`${u.id}_${sName}_${i}`] || {score:'', comm:''};
                    rows += `<div class="admin-row">
                        <label>الفرض ${i}</label>
                        <input type="text" placeholder="النقطة" id="s_${u.id}_${i}" value="${d.score==='--'?'':d.score}" style="width:70px;">
                        <input type="text" placeholder="الملاحظة" id="c_${u.id}_${i}" value="${d.comm==='لا ملاحظات'?'':d.comm}" style="flex:1;">
                    </div>`;
                }
                return `<div style="background:rgba(212,175,55,0.05); padding:15px; border-radius:20px; border:1px solid var(--gold); margin-bottom:20px;">
                    <h3 style="color:var(--gold); margin:0 0 10px 0;">${u.name} ${u.role==='admin'?'(إدارة)':''}</h3>${rows}</div>`;
            }).join('');
        }

        function closeAdmin() {
            let updates = {};
            users.forEach(u => {
                for(let i=1; i<=6; i++) {
                    updates[`/scores/${u.id}_${currentUser.subject}_${i}`] = {
                        score: document.getElementById(`s_${u.id}_${i}`).value || '--',
                        comm: document.getElementById(`c_${u.id}_${i}`).value || 'لا ملاحظات'
                    };
                }
            });
            db.ref().update(updates).then(() => {
                document.getElementById('admin-panel').classList.add('hidden');
                alert("تم الحفظ والمزامنة عند الجميع!");
            });
        }

        function showView(id) {
            document.querySelectorAll('body > div:not(#admin-panel)').forEach(v => v.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'app-screen') renderApp();
            if(id === 'store-screen') renderStore();
            if(id === 'custom-screen') renderInventory();
        }

        function renderStore() {
            const cont = document.getElementById('store-content');
            const categories = [
                { title: "باكيت الأندية", type: "clubs" },
                { title: "خلفيات الألوان الملكية", type: "color" },
                { title: "باكيت التأثيرات والخصائص", type: ["feature", "effect"] }
            ];

            cont.innerHTML = categories.map(cat => {
                const items = shopItems.filter(item => 
                    Array.isArray(cat.type) ? cat.type.includes(item.type) : item.type === cat.type
                );
                return `
                <div class="store-section">
                    <h2>${cat.title}</h2>
                    <div style="display:flex; flex-wrap:wrap; gap:15px;">
                        ${items.map(item => `
                            <div class="item-card" style="width:180px;">
                                ${item.img ? `<img src="${item.img}" style="width:50px;height:50px;margin-bottom:10px;">` : `<i class="fa-solid fa-gem" style="font-size:2rem;color:var(--gold);margin-bottom:10px;"></i>`}
                                <h4>${item.name}</h4><p>${item.price} ذهب</p>
                                <button class="btn-gold" onclick="buyItem('${item.id}', ${item.price})">شراء</button>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        function buyItem(id, price) {
            let bal = parseInt(document.getElementById('user-balance').innerText);
            if(bal < price) return alert("ذهبك لا يكفي!");
            if(!storeData[currentUser.id]) storeData[currentUser.id] = {spent:0, owned:[]};
            if(storeData[currentUser.id].owned?.includes(id)) return alert("تملكه بالفعل!");
            
            storeData[currentUser.id].spent += price;
            if(!storeData[currentUser.id].owned) storeData[currentUser.id].owned = [];
            storeData[currentUser.id].owned.push(id);
            db.ref('store').set(storeData).then(() => alert("تم الشراء بنجاح!"));
        }

        function renderInventory() {
            const cont = document.getElementById('inventory-list');
            cont.innerHTML = (storeData[currentUser.id]?.owned || []).map(oid => {
                let item = shopItems.find(x => x.id === oid);
                return (item?.bg || item?.type === 'effect') ? `<div class="item-card"><h4>${item.name}</h4><button class="btn-gold" onclick="applyBG('${item.bg}')">تفعيل</button></div>` : '';
            }).join('');
        }

        function applyBG(bg) {
            if(bg==='original' || !bg) document.body.style.backgroundImage = 'radial-gradient(circle at 50% -20%, #1a1a1a 0%, #000 100%)';
            else {
                document.body.style.backgroundImage = bg;
                document.body.style.backgroundSize = "cover";
            }
        }

        function processImage(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if(!storeData[currentUser.id]) storeData[currentUser.id] = {spent:0, owned:[]};
                storeData[currentUser.id].avatar = e.target.result;
                db.ref('store').set(storeData);
            };
            reader.readAsDataURL(input.files[0]);
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>